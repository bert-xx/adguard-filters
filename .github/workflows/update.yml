name: Update DNS Rewrite Filters

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process Filters
        shell: python
        run: |
          import requests
          
          # Источник (hosts-файл с IP прокси сервера)
          source_url = "https://raw.githubusercontent.com/ImMALWARE/dns.malw.link/refs/heads/master/hosts"
          # Ключевые слова для поиска нужных сервисов
          target_keywords = ["OpenAI", "Google", "Grok", "Claude", "xAI"]
          output_file = "my_filters.txt"
          
          print(f"Загружаю данные из {source_url}...")
          r = requests.get(source_url)
          if r.status_code != 200:
              print(f"Ошибка загрузки: {r.status_code}")
              exit(1)
          
          lines = r.text.splitlines()
          result = []
          active = False
          count = 0
          
          print("--- Начинаю парсинг разделов ---")

          for line in lines:
              s = line.strip()
              if not s: continue
              
              # Если строка — заголовок раздела (начинается с #)
              if s.startswith("#"):
                  is_target = any(k.lower() in s.lower() for k in target_keywords)
                  if is_target:
                      active = True
                      result.append(f"\n! --- Раздел: {s.lstrip('# ').strip()} ---")
                      print(f"Обрабатываю раздел: {s}")
                  else:
                      active = False
              
              # Если мы в активном разделе и это строка с данными (IP Domain)
              if active and not s.startswith("#"):
                  parts = s.split()
                  # Проверяем, что в строке есть минимум IP и Домен
                  if len(parts) >= 2:
                      ip = parts[0]
                      domain = parts[1].lower()
                      
                      # Игнорируем заглушки 0.0.0.0 или 127.0.0.1, если они попадутся
                      if ip not in ["0.0.0.0", "127.0.0.1"]:
                          # Формат: ||domain.com^$dnsrewrite=IP
                          rule = f"||{domain}^$dnsrewrite={ip}"
                          result.append(rule)
                          count += 1

          if count == 0:
              print("!!! ОШИБКА: Домены не найдены. Проверьте ключевые слова.")
              exit(1)

          # Запись итогового файла
          with open(output_file, "w", encoding="utf-8") as f:
              f.write("! Title: My AI & Google DNS Rewrite\n")
              f.write(f"! Total rules: {count}\n\n")
              f.write("\n".join(result))
          
          print(f"Успех! Сгенерировано {count} правил DNS Rewrite.")

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add my_filters.txt
          git commit -m "Update rewrite filters: $(date)" || exit 0
          git push origin main --force
